<!--
@license
Copyright (c) 2015 Glenn Vandeuren. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<!--
An search bar a la material design.

Example:

    <paper-search>
      <paper-icon-button icon="ps-icons:search" open-paper-search></paper-icon-button>
      <paper-search-bar value="{{searchValue}}"></paper-search-bar>
    </paper-search>

@group App Elements
@element paper-search
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="paper-search">

  <template>
    <style>
      :host {
        box-sizing: border-box;
        display: inline-block;
        padding: 16px;
        width: var(--paper-search-width);
        background: var(--paper-search-background);
        /*@apply(--layout-horizontal);
        @apply(--layout-center);*/
        @apply(--paper-search);
      }
      .content-wrapper {
        width: var(--paper-search-width);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      :host(.opened) {
        background: var(--paper-search-opened-background);
        width: var(--paper-search-opened-width);
      }
      :host(.opened) .content-wrapper {
        width: var(--paper-search-opened-width);
      }
      :host:not(.opened) paper-icon-button,
      :host[custom-close] paper-icon-button,
      :host[custom-cancel] paper-icon-button {
        display: none;
      }
      :host .content-wrapper ::content > paper-search-bar ::content > iron-icon {
        display: none;
      }
      :host:not(.opened) .content-wrapper ::content > paper-search-bar,
      :host:not(.opened) .content-wrapper ::content > paper-search-bar ::content > .input-wrapper {
        display: none;
        opacity: 0;
        will-transform: opacity visibility width;
        width: 0;
      }

      :host(.opened) .content-wrapper ::content > paper-search-bar,
      :host(.opened) .content-wrapper ::content > paper-search-bar ::content > .input-wrapper {
        opacity: 0.88;
        display: flex;
        width: 100%;
        transition: width 0.2s ease-in, opacity 0.4s cubic-bezier(0, 0.25, 0.5, 0.75);
        /*transform: scaleX(100%);*/
      }
      :host(.opened) paper-icon-button {
        opacity: 0.54;
        visibility: visible;
        padding: 4px;
        transition: opacity 0.2s cubic-bezier(0, 0.25, 0.5, 0.75), padding 0.4s ease-in;
      }
      :host(.opened) .content-wrapper ::content > paper-icon-button[icon="ps-icons:search"] {
        opacity: 0.54;
        margin-right: 8px;
        pointer-events: none;
        padding: 4px;
        cursor: default;
        transition: opacity 0.2s cubic-bezier(0, 0.25, 0.5, 0.75), padding 0.2s ease-in;
      }
      /*:host(.opened) ::content > paper-search-bar {
        opacity: 1;
        visibility: visible;
        width: 100%;
        transition: width 0.2s ease-in;
      }*/
    </style>
    <div class="content-wrapper">
      <content id="content"></content>
      <paper-icon-button icon="ps-icons:close" on-tap="cancel"></paper-icon-button>
    </div>
  </template>
</dom-module>

<script>

  Polymer({

    is: 'paper-search',

    properties: {
      /**
       * The search value
       */
       value: {
         type: String,
         notify: true
       },

       /**
        * Set to true for adding a close button yourself
        */
       customClose: {
         type: Boolean
       },

       /**
        * Set to true for adding a cancel button and method yourself
        */
       customCancel: {
         type: Boolean,
         observer: '_customCancelChanged',
         value: true
       },

       /**
        *The attribute for setting on a child for opening the search bar
        */
       openAttribute: {
         type: String,
         value: 'open-paper-search'
       },

       /**
        *The attribute for setting on a child for closing the search bar
        */
       closeAttribute: {
         type: String,
         value: 'close-paper-search'
       },

       /**
        * The attribute for setting on a child to cancel the input
        */
       CancelAttribute: {
         type: String,
         value: 'cancel-paper-search'
       },

        opened: {
          type: Boolean,
          value: false,
          observer: '_openedChanged'
        }
     },

    listeners: {
      tap: '_tapHandler'
    },

    _customCancelChanged: function(cancel) {
      var distributedNodes = Polymer.dom(this.$.content).getDistributedNodes();
      distributedNodes.forEach(function(node) {
        if (node.localName === 'paper-search-bar') {
          this._searchBar = node;
          node.setAttribute('custom-cancel', cancel);
        }
        if (node.localName === 'paper-icon-button' && node.hasAttribute('open-paper-search')) {
          this._openBtn = node;
        }
      }.bind(this));
      // this.parent.querySelector('paper-search-bar').setAttribute('custom-cancel', cancel);
    },

    _tapHandler: function() {
      var target = Polymer.dom(event).localTarget;
      var searchBar = this.querySelector('paper-search-bar');
      if (target.hasAttribute(this.openAttribute)) {
        this.open();
      } else if (this.customClose && target.hasAttribute(this.closeAttribute)) {
        this.close();
      } else if (this.customCancel && target.hasAttribute(this.cancelAttribute)) {
        this.cancel();
      }
    },

    _openedChanged: function(open) {
      if (open === true) {
        this.open();
      } else {
        this.close();
      }
    },

    open: function() {
      this.classList.add('opened');
      this._openBtn.setAttribute('disabled', '');
    },

    close: function() {
      this.classList.remove('opened');
      this._openBtn.removeAttribute('disabled', '');
    },

    cancel: function() {
      if (this._searchBar.value) {
        this._searchBar.value = null;
      } else {
        this.close();
      }
    }


  });

</script>
